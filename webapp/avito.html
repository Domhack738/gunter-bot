<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUNTER ¬∑ –ê–≤–∏—Ç–æ</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="app">
        <div class="avito-container">
            <div class="avito-header">
                <h1 class="avito-title">üõí –ê–í–ò–¢–û –†–´–ù–û–ö</h1>
                <button onclick="showSellForm()" class="btn-sell">+ –ü—Ä–æ–¥–∞—Ç—å</button>
            </div>
            
            <!-- –ë–∞–ª–∞–Ω—Å -->
            <div class="balance" style="margin-bottom: 20px; justify-content: center;">
                <span class="balance-cash">üí∞ <span id="cashBalance">0</span>$</span>
                <span class="balance-token">üéÆ <span id="tokenBalance">0</span> GTR</span>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
            <div id="listingsContainer" class="listings">
                <p class="text-dim">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...</p>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
            <button onclick="window.location.href='/garage'" style="
                width: 100%;
                margin-top: 20px;
                background: #2a2f34;
                color: white;
                border: none;
                padding: 16px;
                border-radius: 16px;
                font-weight: 700;
                cursor: pointer;
            ">üîô –ù–ê–ó–ê–î –í –ì–ê–†–ê–ñ</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ -->
    <div id="sellModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px;">
        <div style="background: var(--bg-card); border-radius: 24px; padding: 24px;">
            <h2 style="color: var(--accent); margin-bottom: 20px;">–ü—Ä–æ–¥–∞—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</h2>
            
            <select id="sellType" class="part-select" style="width: 100%; margin-bottom: 12px;">
                <option value="engine">–î–≤–∏–≥–∞—Ç–µ–ª—å</option>
                <option value="turbo">–¢—É—Ä–±–∏–Ω–∞</option>
                <option value="suspension">–ü–æ–¥–≤–µ—Å–∫–∞</option>
                <option value="subwoofer">–°–∞–±–≤—É—Ñ–µ—Ä</option>
            </select>
            
            <input type="number" id="sellLevel" placeholder="–£—Ä–æ–≤–µ–Ω—å (1-5)" class="part-select" style="width: 100%; margin-bottom: 12px;">
            <input type="number" id="sellPrice" placeholder="–¶–µ–Ω–∞ –≤ $" class="part-select" style="width: 100%; margin-bottom: 12px;">
            <textarea id="sellDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="part-select" style="width: 100%; margin-bottom: 12px; height: 80px;"></textarea>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="createListing()" class="btn-upgrade" style="flex: 1;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <button onclick="hideSellForm()" class="btn-upgrade" style="flex: 1; background: #666;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        let tg_id = tg.initDataUnsafe?.user?.id;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        async function loadListings() {
            try {
                const response = await fetch('/api/avito/listings');
                const listings = await response.json();
                
                const container = document.getElementById('listingsContainer');
                
                if (listings.length === 0) {
                    container.innerHTML = '<p class="text-dim" style="text-align: center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
                    return;
                }
                
                let html = '';
                listings.forEach(listing => {
                    let itemInfo = '';
                    if (listing.item_type === 'engine') itemInfo = `‚ö° –î–≤–∏–≥–∞—Ç–µ–ª—å ${listing.item_data.level} —É—Ä.`;
                    if (listing.item_type === 'turbo') itemInfo = `üí® –¢—É—Ä–±–∏–Ω–∞ ${listing.item_data.level} —É—Ä.`;
                    if (listing.item_type === 'suspension') itemInfo = `üî© –ü–æ–¥–≤–µ—Å–∫–∞ ${listing.item_data.level} —É—Ä.`;
                    if (listing.item_type === 'subwoofer') itemInfo = `üîä –°–∞–±–≤—É—Ñ–µ—Ä ${listing.item_data.level} —É—Ä.`;
                    
                    html += `
                        <div class="listing-card">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--accent); font-weight: 700;">@${listing.seller_username}</span>
                                <span style="color: #85bb65; font-weight: 700;">${listing.price}$</span>
                            </div>
                            <div style="font-size: 18px; margin-bottom: 8px;">${itemInfo}</div>
                            <div style="color: var(--text-dim); font-size: 14px; margin-bottom: 12px;">${listing.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                            <button onclick="buyItem(${listing.id}, ${listing.price})" class="btn-upgrade" style="width: 100%;">–ö—É–ø–∏—Ç—å</button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
                const userResp = await fetch(`/api/user/${tg_id}`);
                const userData = await userResp.json();
                document.getElementById('cashBalance').textContent = Math.floor(userData.balance_cash);
                document.getElementById('tokenBalance').textContent = userData.balance_token.toFixed(2);
                
            } catch (error) {
                console.error('Error loading listings:', error);
            }
        }
        
        // –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞
        async function buyItem(listingId, price) {
            if (!confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price}$?`)) return;
            
            try {
                const response = await fetch(`/api/avito/buy/${tg_id}/${listingId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                } else {
                    alert('‚úÖ –¢–æ–≤–∞—Ä –∫—É–ø–ª–µ–Ω!');
                    loadListings();
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –ø—Ä–æ–¥–∞–∂–∏
        function showSellForm() {
            document.getElementById('sellModal').style.display = 'block';
        }
        
        function hideSellForm() {
            document.getElementById('sellModal').style.display = 'none';
        }
        
        // –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
        async function createListing() {
            const type = document.getElementById('sellType').value;
            const level = parseInt(document.getElementById('sellLevel').value);
            const price = parseInt(document.getElementById('sellPrice').value);
            const desc = document.getElementById('sellDesc').value;
            
            if (!level || !price) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const response = await fetch(`/api/avito/create/${tg_id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        item_type: type,
                        item_data: {level: level},
                        price: price,
                        description: desc
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
                    hideSellForm();
                    loadListings();
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        if (tg_id) {
            loadListings();
        }
    </script>
</body>
</html>